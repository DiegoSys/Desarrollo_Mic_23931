<div class="institutional-container">
  <div class="institutional-card-container" [class.opacity-50]="loading">
    <!-- Header dentro del card contenedor -->
    <div class="card-header-container">
      <div class="header-row">
        <span class="header-icon"><i class="pi pi-sliders-h"></i></span>
        <div class="header-titles">
          <span class="header-title-main">Campos {{ codigoSeccion ? 'de ' + codigoSeccion : 'del Formulario' }}</span>
          <span class="header-title-sub"><i class="pi pi-list"></i> {{ codigoSeccion ? 'Administración de campos por
            sección' : 'Administración de campos' }}</span>
        </div>
        <button class="btn btn-institutional header-btn" (click)="openForm()" *ngIf="codigoSeccion || rows?.length > 0">
          <i class="pi pi-plus"></i> Nuevo Campo
        </button>
      </div>
    </div>

    <div class="separator-line"></div>

    <!-- Barra de búsqueda -->
    <div class="selector-toolbar">
      <span class="search-wrapper">
        <input type="text" pInputText [(ngModel)]="searchValue" placeholder="Buscar..."
          (ngModelChange)="onSearchInputChange($event)" class="selector-search-input" autocomplete="off" />
        <button type="button" (click)="handleSearch()" class="p-button-sm selector-search-btn" aria-label="Buscar">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
            <circle cx="9" cy="9" r="7" stroke="#fff" stroke-width="2" />
            <line x1="14.2" y1="14.2" x2="18" y2="18" stroke="#fff" stroke-width="2" stroke-linecap="round" />
          </svg>
        </button>
      </span>
    </div>

    <!-- Modal de formulario dentro del card principal -->
    <div *ngIf="showForm">
      <div class="modal-backdrop">
        <div class="modal-card">
          <div class="modal-header">
            <h3>
              <i class="pi" [ngClass]="editing ? 'pi-pencil' : 'pi-plus'"></i>
              {{ editing ? 'Editar Campo' : 'Nuevo Campo' }}
            </h3>
            <button class="btn-close" (click)="closeForm()">&times;</button>
          </div>
          <form #campoForm="ngForm" (ngSubmit)="save()" autocomplete="off">
            <div class="form-row">
              <div class="form-group" *ngIf="!codigoSeccion">
                <label for="codigo">Código</label>
                <input id="codigo" name="codigo" type="text" class="form-control" required
                  [(ngModel)]="formModel.codigo" maxlength="30" [readonly]="editing" placeholder="CAM-001">
              </div>
              <div class="form-group" *ngIf="codigoSeccion && editing">
                <label>Código Completo</label>
                <input type="text" class="form-control" [(ngModel)]="formModel.codigoCompleto" readonly>
              </div>
              <div class="form-group" *ngIf="codigoSeccion && !editing">
                <label for="codigo">Código</label>
                <input id="codigo" name="codigo" type="text" class="form-control" required
                  [(ngModel)]="formModel.codigo" maxlength="30" placeholder="CAM-001">
              </div>
              <div class="form-group">
                <label for="nombre">Nombre</label>
                <input id="nombre" name="nombre" type="text" class="form-control" required
                  [(ngModel)]="formModel.nombre" maxlength="100" placeholder="Nombre del campo">
              </div>
            </div>
            <div class="form-group matrix-inputs">
              <div class="matrix-info">
                <div class="alert alert-info">
                  <i class="pi pi-info-circle"></i>
                  <span>
                    <strong>Dimensiones de la matriz:</strong>
                    Aquí puedes definir si este campo será una matriz de <b>n x n</b> (por ejemplo, para tablas,
                    cuadrículas o matrices de opciones).
                    Ingresa el número de filas y columnas que tendrá la matriz. Si solo deseas un campo simple, deja
                    ambos valores en 1.
                  </span>
                </div>
              </div>
              <div class="matrix-inputs-row">
                <div class="matrix-input-container">
                  <label for="filaMatriz">Fila</label>
                  <div class="input-wrapper">
                    <i class="pi pi-sort-numeric-down"></i>
                    <input id="filaMatriz" name="filaMatriz" type="number" class="form-control matrix-input"
                      [(ngModel)]="formModel.filaMatriz" min="1" step="1" placeholder="1">
                  </div>
                </div>
                <div class="matrix-input-container">
                  <label for="columnaMatriz">Columna</label>
                  <div class="input-wrapper">
                    <i class="pi pi-sort-numeric-down-alt"></i>
                    <input id="columnaMatriz" name="columnaMatriz" type="number" class="form-control matrix-input"
                      [(ngModel)]="formModel.columnaMatriz" min="1" step="1" placeholder="1">
                  </div>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="tipo">Tipo</label>
                <select id="tipo" name="tipo" class="form-control" required [(ngModel)]="formModel.tipoCampo">
                  <option value="">Seleccione tipo</option>
                  <option *ngFor="let tipo of tiposCampo" [value]="tipo.codigo">
                    {{ tipo.nombre }}
                  </option>
                </select>
              </div>
              <div class="form-group">
                <label for="descripcion">Descripción</label>
                <input id="descripcion" name="descripcion" type="text" class="form-control"
                  [(ngModel)]="formModel.descripcion" maxlength="250" placeholder="Descripción del campo">
              </div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-outline" (click)="closeForm()">Cancelar</button>
              <button type="submit" class="btn btn-institutional" [disabled]="campoForm.invalid">
                <i class="pi pi-save"></i> {{ editing ? 'Actualizar' : 'Guardar' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Dual Column View -->
    <div class="sections-manager" *ngIf="codigoSeccion; else normalView">
      <div class="sections-container">
        <!-- Available Campos -->
        <div class="sections-column available" cdkDropList #availableList="cdkDropList"
          [cdkDropListData]="availableCampos" [cdkDropListConnectedTo]="[associatedList]"
          (cdkDropListDropped)="drop($event)">
          <div class="column-header">
            <h4><i class="pi pi-list"></i> Disponibles</h4>
            <span class="badge">{{ totalAvailableRecords || 0 }}</span>
          </div>
          <div class="sections-list">
            <div class="section-item" *ngFor="let campo of availableCampos" cdkDrag>
              <div class="section-card">
                <div class="section-header">
                  <h5>{{ campo.nombre }}</h5>
                  <span class="section-code">{{ campo.codigo }}</span>
                </div>
                <p class="section-desc" *ngIf="campo.descripcion">{{ campo.descripcion }}</p>
                <div class="campo-type-display" *ngIf="campo.tipoCampo" [attr.data-type]="campo.tipoCampo">
                  <i class="pi" [ngClass]="getFieldIcon(campo.tipoCampo)"></i>
                  {{ getTipoCampoNombre(campo.tipoCampo) }}
                </div>
                <div class="section-actions">
                  <button class="btn-icon" (click)="openForm(campo)" title="Editar">
                    <i class="pi pi-pencil"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="empty-state" *ngIf="availableCampos?.length === 0 && totalAvailableRecords === 0">
              <i class="pi pi-info-circle"></i>
              <p>Todos los campos están asociados</p>
            </div>
            <div class="empty-state" *ngIf="availableCampos?.length === 0 && totalAvailableRecords > 0">
              <i class="pi pi-info-circle"></i>
              <p>No hay más campos en esta página</p>
              <button class="btn btn-outline" (click)="handlePageChange({first: 0, rows: availableSize})">
                <i class="pi pi-angle-double-left"></i> Ir a la primera página
              </button>
            </div>
          </div>
          <p-paginator *ngIf="totalAvailableRecords > availableSize" [rows]="availableSize"
            [totalRecords]="totalAvailableRecords" [first]="availablePage * availableSize"
            (onPageChange)="handlePageChange($event)" styleClass="dual-paginator"></p-paginator>
        </div>

        <!-- Associated Campos -->
        <div class="sections-column associated" cdkDropList #associatedList="cdkDropList"
          [cdkDropListData]="associatedCampos" [cdkDropListConnectedTo]="[availableList]"
          (cdkDropListDropped)="drop($event)">
          <div class="column-header">
            <h4><i class="pi pi-check-circle"></i> Asociados</h4>
            <span class="badge">{{ associatedCampos?.length || 0 }}</span>
          </div>
          <div class="sections-list">
            <div class="section-item" *ngFor="let campo of associatedCampos; let i = index" cdkDrag>
              <div class="section-card">
                <div class="section-header">
                  <h5>{{ campo.nombre }}</h5>
                  <span class="section-code">{{ campo.codigo }}</span>
                </div>
                <p class="section-desc" *ngIf="campo.descripcion">{{ campo.descripcion }}</p>
                <div class="campo-type-display" *ngIf="campo.tipoCampo" [attr.data-type]="campo.tipoCampo">
                  <i class="pi" [ngClass]="getFieldIcon(campo.tipoCampo)"></i>
                  {{ getTipoCampoNombre(campo.tipoCampo) }}
                </div>
                <div class="section-order">
                  <i class="pi pi-sort-numeric-down"></i> Orden: {{ i + 1 }}
                </div>
                <div class="section-actions">
                  <button class="btn-icon" (click)="openForm(campo)" title="Editar">
                    <i class="pi pi-pencil"></i>
                  </button>
                  <button class="btn-icon btn-danger" (click)="removeCampoFromSeccion(campo)" title="Quitar de sección">
                    <i class="pi pi-times"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="empty-state" *ngIf="associatedCampos?.length === 0">
              <i class="pi pi-info-circle"></i>
              <p>Arrastra secciones aquí</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Normal View - SOLO AQUÍ se usa app-preview-card -->
    <ng-template #normalView>
      <div class="cards-grid" *ngIf="rows?.length > 0; else noData">
        <app-preview-card *ngFor="let campo of rows" [title]="campo.nombre" [code]="campo.codigo"
          [description]="campo.descripcion" [date]="getDateValue(campo.fechaCreacion)" [size]="'medium'"
          [previewType]="'field'" [fieldType]="campo.tipoCampo" [showFooter]="true" [showEdit]="true"
          [showDelete]="true" [showView]="false" [showActions]="true" [isInDualView]="false" [isDraggable]="false"
          (onEdit)="openForm(campo)" (onDelete)="confirmDelete(campo)">
          <!-- Contenido específico del preview de campo -->
          <div class="card-content field-preview-content">
            <!-- Vista previa simplificada del campo -->
            <div class="field-preview-visual">
              <div class="field-preview-header">
                <div class="field-preview-title">
                  <span>{{campo.nombre}}</span>
                </div>
                <div class="campo-type" [attr.data-type]="campo.tipoCampo">
                  <i class="pi" [ngClass]="getFieldIcon(campo.tipoCampo)"></i>
                  <span>{{ getTipoCampoNombre(campo.tipoCampo) }}</span>
                </div>
              </div>
              <div class="field-preview-input">
                <ng-container [ngSwitch]="campo.tipoCampo">
                  <input *ngSwitchCase="'TXT'" type="text" class="field-text" placeholder="Ej: Nombre completo"
                    disabled>
                  <textarea *ngSwitchCase="'AREA'" class="field-text" rows="2" placeholder="Ej: Descripción detallada"
                    disabled></textarea>
                  <select *ngSwitchCase="'SEL'" class="field-select" disabled>
                    <option>Seleccione una opción</option>
                    <option>Opción 1</option>
                    <option>Opción 2</option>
                    <option>{{ campo.nombre }}</option>
                  </select>
                  <div *ngSwitchCase="'SELM'" class="field-multiselect">
                    <div class="multi-select-header">
                      <span>Seleccione opciones</span>
                      <i class="pi pi-chevron-down"></i>
                    </div>
                    <div class="multi-select-options">
                      <div class="multi-select-option selected">
                        <i class="pi pi-check"></i>
                        <span>Opción A</span>
                      </div>
                      <div class="multi-select-option">
                        <i class="pi pi-check"></i>
                        <span>Opción B</span>
                      </div>
                      <div class="multi-select-option selected">
                        <i class="pi pi-check"></i>
                        <span>Opción C</span>
                      </div>
                    </div>
                  </div>
                  <div *ngSwitchCase="'NUM'" class="field-number">
                    <input type="number" placeholder="0" min="0" step="1" disabled class="compact-number-input">
                  </div>
                  <input *ngSwitchCase="'DATE'" type="date" class="field-date" disabled>
                  <input *ngSwitchCase="'TIME'" type="time" class="field-time" disabled>
                  <input *ngSwitchCase="'EMAIL'" type="email" class="field-email" placeholder="Ej: usuario@dominio.com"
                    disabled>
                  <input *ngSwitchCase="'CHK'" type="checkbox" class="field-checkbox" disabled>
                  <input *ngSwitchCase="'PASS'" type="password" class="field-password" placeholder="••••••••" disabled>
                  <input *ngSwitchCase="'RADIO'" type="radio" class="field-radio" disabled>
                  <input *ngSwitchCase="'FILE'" type="file" class="field-file" disabled>
                  <input *ngSwitchDefault type="text" class="field-text" [placeholder]="campo.nombre" disabled>
                </ng-container>
              </div>
            </div>
            <!-- Fin preview -->
          </div>
        </app-preview-card>
      </div>

      <p-paginator [rows]="size" [totalRecords]="totalRecords" [first]="page * size"
        (onPageChange)="handlePageChange($event)" styleClass="paginator-compact">
      </p-paginator>
    </ng-template>

    <ng-template #noData>
      <div class="empty-state">
        <i class="pi pi-folder-open"></i>
        <h4>{{ codigoSeccion ? 'No hay campos disponibles' : 'No hay campos registrados' }}</h4>
        <p>Comience agregando un nuevo campo</p>
        <button class="btn btn-institutional" (click)="openForm()">
          <i class="pi pi-plus"></i> Crear Campo
        </button>
      </div>
    </ng-template>

    <p-confirmDialog [style]="{width: '400px'}" [baseZIndex]="10000"></p-confirmDialog>
  </div>
</div>
<app-spinner *ngIf="loading"></app-spinner>